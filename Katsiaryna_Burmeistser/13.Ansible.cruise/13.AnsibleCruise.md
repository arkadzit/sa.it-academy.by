  # 13. Ansible cruise
  ---
  ### Create Ansible Playbook with role(s) to install Nginx server and setup two virtual hosts. + Implement testing role
```
apachy@apachy-server:~/ansible13$ ansible-playbook web.yaml -i hosts.yaml -u root --ask-vault-pass
Vault password:

PLAY [ec_all] *****************************************************************************************************************************

TASK [Gathering Facts] ********************************************************************************************************************
Wednesday 28 April 2021  06:49:14 +0000 (0:00:00.103)       0:00:00.103 *******
ok: [ubuntu]
ok: [centos]

TASK [webserver : Add epel-release repo] **************************************************************************************************
Wednesday 28 April 2021  06:49:21 +0000 (0:00:07.699)       0:00:07.802 *******
skipping: [ubuntu]
ok: [centos]

TASK [webserver : Nginx-RedHat. Install packages] *****************************************************************************************
Wednesday 28 April 2021  06:49:23 +0000 (0:00:01.684)       0:00:09.486 *******
skipping: [ubuntu]
ok: [centos]

TASK [webserver : Nginx. Enable and start servce] *****************************************************************************************
Wednesday 28 April 2021  06:49:24 +0000 (0:00:01.258)       0:00:10.745 *******
skipping: [ubuntu]
ok: [centos]

TASK [webserver : CentOS. Enable firewall port] *******************************************************************************************
Wednesday 28 April 2021  06:49:26 +0000 (0:00:01.651)       0:00:12.396 *******
skipping: [ubuntu]
ok: [centos]

TASK [webserver : reload service firewalld] ***********************************************************************************************
Wednesday 28 April 2021  06:49:28 +0000 (0:00:01.638)       0:00:14.034 *******
skipping: [ubuntu]
changed: [centos]

TASK [webserver : Create sites-available for CentOS] **************************************************************************************
Wednesday 28 April 2021  06:49:29 +0000 (0:00:01.746)       0:00:15.781 *******
skipping: [ubuntu]
ok: [centos]

TASK [webserver : Create sites-enabled for CentOS] ****************************************************************************************
Wednesday 28 April 2021  06:49:31 +0000 (0:00:01.301)       0:00:17.083 *******
skipping: [ubuntu]
ok: [centos]

TASK [webserver : Add Centos site config] *************************************************************************************************
Wednesday 28 April 2021  06:49:32 +0000 (0:00:01.007)       0:00:18.090 *******
skipping: [ubuntu] => (item={'site': 'local-site1.site', 'root': '/var/www/local-site1.site/html'})
skipping: [ubuntu] => (item={'site': 'local-site2.site', 'root': '/var/www/local-site2.site/html'})
ok: [centos] => (item={'site': 'local-site1.site', 'root': '/var/www/local-site1.site/html'})
ok: [centos] => (item={'site': 'local-site2.site', 'root': '/var/www/local-site2.site/html'})

TASK [webserver : Remove Centos nginx config] *********************************************************************************************
Wednesday 28 April 2021  06:49:35 +0000 (0:00:03.263)       0:00:21.354 *******
skipping: [ubuntu]
changed: [centos]

TASK [webserver : Add Centos nginx config] ************************************************************************************************
Wednesday 28 April 2021  06:49:36 +0000 (0:00:01.136)       0:00:22.491 *******
skipping: [ubuntu]
changed: [centos]

TASK [webserver : Create symlink nginx vhost Debian] **************************************************************************************
Wednesday 28 April 2021  06:49:38 +0000 (0:00:01.891)       0:00:24.382 *******
skipping: [ubuntu] => (item={'site': 'local-site1.site', 'root': '/var/www/local-site1.site/html'})
skipping: [ubuntu] => (item={'site': 'local-site2.site', 'root': '/var/www/local-site2.site/html'})
ok: [centos] => (item={'site': 'local-site1.site', 'root': '/var/www/local-site1.site/html'})
ok: [centos] => (item={'site': 'local-site2.site', 'root': '/var/www/local-site2.site/html'})

TASK [webserver : Nginx-Debian. Install packages] *****************************************************************************************
Wednesday 28 April 2021  06:49:40 +0000 (0:00:01.823)       0:00:26.206 *******
skipping: [centos]
ok: [ubuntu]

TASK [webserver : Nginx. Enable and start servce] *****************************************************************************************
Wednesday 28 April 2021  06:49:43 +0000 (0:00:03.244)       0:00:29.450 *******
skipping: [centos]
ok: [ubuntu]

TASK [webserver : Add Debian site config] *************************************************************************************************
Wednesday 28 April 2021  06:49:44 +0000 (0:00:01.311)       0:00:30.762 *******
skipping: [centos] => (item={'site': 'local-site1.site', 'root': '/var/www/local-site1.site/html'})
skipping: [centos] => (item={'site': 'local-site2.site', 'root': '/var/www/local-site2.site/html'})
ok: [ubuntu] => (item={'site': 'local-site1.site', 'root': '/var/www/local-site1.site/html'})
ok: [ubuntu] => (item={'site': 'local-site2.site', 'root': '/var/www/local-site2.site/html'})

TASK [webserver : Create symlink nginx vhost Debian] **************************************************************************************
Wednesday 28 April 2021  06:49:48 +0000 (0:00:03.087)       0:00:33.850 *******
skipping: [centos] => (item={'site': 'local-site1.site', 'root': '/var/www/local-site1.site/html'})
skipping: [centos] => (item={'site': 'local-site2.site', 'root': '/var/www/local-site2.site/html'})
ok: [ubuntu] => (item={'site': 'local-site1.site', 'root': '/var/www/local-site1.site/html'})
ok: [ubuntu] => (item={'site': 'local-site2.site', 'root': '/var/www/local-site2.site/html'})

TASK [webserver : Check connection to Localhost] ******************************************************************************************
Wednesday 28 April 2021  06:49:50 +0000 (0:00:01.984)       0:00:35.835 *******
ok: [centos]
ok: [ubuntu]

TASK [webserver : print out] **************************************************************************************************************
Wednesday 28 April 2021  06:49:51 +0000 (0:00:01.191)       0:00:37.026 *******
ok: [centos] => {
    "msg": {
        "changed": false,
        "elapsed": 0,
        "failed": false,
        "match_groupdict": {},
        "match_groups": [],
        "path": null,
        "port": 80,
        "search_regex": null,
        "state": "started"
    }
}
ok: [ubuntu] => {
    "msg": {
        "changed": false,
        "elapsed": 0,
        "failed": false,
        "match_groupdict": {},
        "match_groups": [],
        "path": null,
        "port": 80,
        "search_regex": null,
        "state": "started"
    }
}

TASK [webserver : Templates] **************************************************************************************************************
Wednesday 28 April 2021  06:49:51 +0000 (0:00:00.265)       0:00:37.291 *******
ok: [centos]
ok: [ubuntu]

TASK [webserver : Check template] *********************************************************************************************************
Wednesday 28 April 2021  06:49:53 +0000 (0:00:01.845)       0:00:39.137 *******
ok: [centos]
ok: [ubuntu]

TASK [webserver : print out] **************************************************************************************************************
Wednesday 28 April 2021  06:49:54 +0000 (0:00:01.243)       0:00:40.380 *******
ok: [centos] => {
    "msg": [
        "### Ansible managed",
        "",
        "127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4",
        "::1         localhost localhost.localdomain localhost6 localhost6.localdomain6",
        "",
        "192.168.202.5   local-site1.site",
        "192.168.202.6   local-site2.site"
    ]
}
ok: [ubuntu] => {
    "msg": [
        "### Ansible managed",
        "",
        "127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4",
        "::1         localhost localhost.localdomain localhost6 localhost6.localdomain6",
        "",
        "192.168.202.5   local-site1.site",
        "192.168.202.6   local-site2.site"
    ]
}

TASK [webserver : Copy Home Page] *********************************************************************************************************
Wednesday 28 April 2021  06:49:54 +0000 (0:00:00.255)       0:00:40.636 *******
ok: [centos] => (item={'site': 'local-site1.site', 'root': '/var/www/local-site1.site/html'})
changed: [ubuntu] => (item={'site': 'local-site1.site', 'root': '/var/www/local-site1.site/html'})
ok: [centos] => (item={'site': 'local-site2.site', 'root': '/var/www/local-site2.site/html'})
changed: [ubuntu] => (item={'site': 'local-site2.site', 'root': '/var/www/local-site2.site/html'})

TASK [webserver : Check content to the sites] *********************************************************************************************
Wednesday 28 April 2021  06:49:59 +0000 (0:00:04.811)       0:00:45.448 *******
ok: [centos] => (item={'name': 'local-site1.site', 'ip': '192.168.202.5'})
ok: [ubuntu] => (item={'name': 'local-site1.site', 'ip': '192.168.202.5'})
ok: [centos] => (item={'name': 'local-site2.site', 'ip': '192.168.202.6'})
ok: [ubuntu] => (item={'name': 'local-site2.site', 'ip': '192.168.202.6'})

TASK [webserver : print out] **************************************************************************************************************
Wednesday 28 April 2021  06:50:02 +0000 (0:00:02.822)       0:00:48.270 *******
ok: [centos] => {
    "msg": "<html>\n\t    <head>\n\t\t            <title>Welcome to Site1.com!</title>\n\t\t\t        </head>\n\t\t\t\t    <body>\n\t\t\t\t\t            <h1>Success!  The site1.com server block is working!</h1>\n\t\t\t\t\t\t        </body>\n</html>\n | \n<html>\n\t    <head>\n\t\t            <title>Welcome to Site2.com!</title>\n\t\t\t        </head>\n\t\t\t\t    <body>\n\t\t\t\t\t            <h1>Success!  The site2.com server block is working!</h1>\n\t\t\t\t\t\t        </body>\n</html>\n\n "
}
ok: [ubuntu] => {
    "msg": "<html>\n\t    <head>\n\t\t            <title>Welcome to Site1.com!</title>\n\t\t\t        </head>\n\t\t\t\t    <body>\n\t\t\t\t\t            <h1>Success!  The site1.com server block is working!</h1>\n\t\t\t\t\t\t        </body>\n</html>\n | \n<html>\n\t    <head>\n\t\t            <title>Welcome to Site2.com!</title>\n\t\t\t        </head>\n\t\t\t\t    <body>\n\t\t\t\t\t            <h1>Success!  The site2.com server block is working!</h1>\n\t\t\t\t\t\t        </body>\n</html>\n\n "
}

TASK [check : Check SUDO with NOPASSWD] ***************************************************************************************************
Wednesday 28 April 2021  06:50:02 +0000 (0:00:00.265)       0:00:48.536 *******
ok: [centos]
ok: [ubuntu]

TASK [check : Check public repositories] **************************************************************************************************
Wednesday 28 April 2021  06:50:03 +0000 (0:00:01.011)       0:00:49.547 *******
ok: [centos] => (item={'url': 'ftp.by.debian.org', 'port': 80})
ok: [ubuntu] => (item={'url': 'ftp.by.debian.org', 'port': 80})
ok: [centos] => (item={'url': 'ftp.byfly.by', 'port': 80})
ok: [ubuntu] => (item={'url': 'ftp.byfly.by', 'port': 80})
ok: [centos] => (item={'url': 'pypi.org', 'port': 443})
ok: [ubuntu] => (item={'url': 'pypi.org', 'port': 443})

TASK [check : Check connection to doker] **************************************************************************************************
Wednesday 28 April 2021  06:50:06 +0000 (0:00:03.280)       0:00:52.827 *******
ok: [centos] => (item=https://registry.hub.docker.com)
ok: [ubuntu] => (item=https://registry.hub.docker.com)

TASK [check : Print output] ***************************************************************************************************************
Wednesday 28 April 2021  06:50:08 +0000 (0:00:01.827)       0:00:54.655 *******
ok: [centos] => (item=200) => {
    "msg": "200"
}
ok: [ubuntu] => (item=200) => {
    "msg": "200"
}

TASK [check : Check RAM] ******************************************************************************************************************
Wednesday 28 April 2021  06:50:09 +0000 (0:00:00.286)       0:00:54.942 *******
ok: [centos] => (item={'real': {'total': 4096, 'used': 296, 'free': 3800}, 'swap': {'cached': 0, 'total': 6144, 'free': 6143, 'used': 1}, 'nocache': {'used': 141, 'free': 3955}}) => {
    "ansible_loop_var": "item",
    "changed": false,
    "item": {
        "nocache": {
            "free": 3955,
            "used": 141
        },
        "real": {
            "free": 3800,
            "total": 4096,
            "used": 296
        },
        "swap": {
            "cached": 0,
            "free": 6143,
            "total": 6144,
            "used": 1
        }
    },
    "msg": "All assertions passed"
}
ok: [ubuntu] => (item={'real': {'total': 4096, 'used': 317, 'free': 3779}, 'nocache': {'free': 4002, 'used': 94}, 'swap': {'total': 6144, 'free': 6143, 'used': 1, 'cached': 0}}) => {
    "ansible_loop_var": "item",
    "changed": false,
    "item": {
        "nocache": {
            "free": 4002,
            "used": 94
        },
        "real": {
            "free": 3779,
            "total": 4096,
            "used": 317
        },
        "swap": {
            "cached": 0,
            "free": 6143,
            "total": 6144,
            "used": 1
        }
    },
    "msg": "All assertions passed"
}


```

### ### Molecule test of webserver on CentOS, Debian, Alpine docker containers

```

apachy@apachy-server:~/ansible13/roles/webserver$ molecule test
INFO     default scenario test matrix: dependency, lint, cleanup, destroy, syntax, create, prepare, converge, idempotence, side_effect, verify, cleanup, destroy
INFO     Performing prerun...
INFO     Added ANSIBLE_ROLES_PATH=~/.ansible/roles:/usr/share/ansible/roles:/etc/ansible/roles:../../../.cache/roles
INFO     Running default > dependency
WARNING  Skipping, missing the requirements file.
WARNING  Skipping, missing the requirements file.
INFO     Running default > lint
INFO     Lint is disabled.
INFO     Running default > cleanup
WARNING  Skipping, cleanup playbook not configured.
INFO     Running default > destroy
INFO     Sanity checks: 'docker'

PLAY [Destroy] *********************************************************************************************

TASK [Destroy molecule instance(s)] ************************************************************************
changed: [localhost] => (item=instance_centos)
changed: [localhost] => (item=instance_debian)
changed: [localhost] => (item=instance_alpine)

TASK [Wait for instance(s) deletion to complete] ***********************************************************
ok: [localhost] => (item={'started': 1, 'finished': 0, 'ansible_job_id': '399551910352.76981', 'results_file': '/home/apachy/.ansible_async/399551910352.76981', 'changed': True, 'failed': False, 'item': {'image': 'centos:latest', 'name': 'instance_centos'}, 'ansible_loop_var': 'item'})
ok: [localhost] => (item={'started': 1, 'finished': 0, 'ansible_job_id': '367173765499.77007', 'results_file': '/home/apachy/.ansible_async/367173765499.77007', 'changed': True, 'failed': False, 'item': {'image': 'debian:latest', 'name': 'instance_debian'}, 'ansible_loop_var': 'item'})
ok: [localhost] => (item={'started': 1, 'finished': 0, 'ansible_job_id': '513106230010.77032', 'results_file': '/home/apachy/.ansible_async/513106230010.77032', 'changed': True, 'failed': False, 'item': {'image': 'alpine:latest', 'name': 'instance_alpine'}, 'ansible_loop_var': 'item'})

TASK [Delete docker network(s)] ****************************************************************************

PLAY RECAP *************************************************************************************************
localhost                  : ok=2    changed=1    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0

INFO     Running default > syntax

playbook: /home/apachy/ansible13/roles/webserver/molecule/default/converge.yml
INFO     Running default > create

PLAY [Create] **********************************************************************************************

TASK [Log into a Docker registry] **************************************************************************
skipping: [localhost] => (item={'image': 'centos:latest', 'name': 'instance_centos'})
skipping: [localhost] => (item={'image': 'debian:latest', 'name': 'instance_debian'})
skipping: [localhost] => (item={'image': 'alpine:latest', 'name': 'instance_alpine'})

TASK [Check presence of custom Dockerfiles] ****************************************************************
ok: [localhost] => (item={'image': 'centos:latest', 'name': 'instance_centos'})
ok: [localhost] => (item={'image': 'debian:latest', 'name': 'instance_debian'})
ok: [localhost] => (item={'image': 'alpine:latest', 'name': 'instance_alpine'})

TASK [Create Dockerfiles from image names] *****************************************************************
changed: [localhost] => (item={'image': 'centos:latest', 'name': 'instance_centos'})
changed: [localhost] => (item={'image': 'debian:latest', 'name': 'instance_debian'})
changed: [localhost] => (item={'image': 'alpine:latest', 'name': 'instance_alpine'})

TASK [Discover local Docker images] ************************************************************************
ok: [localhost] => (item={'diff': [], 'dest': '/home/apachy/.cache/molecule/webserver/default/Dockerfile_centos_latest', 'src': '/home/apachy/.ansible/tmp/ansible-tmp-1619598008.0377407-264508980829242/source', 'md5sum': '486f0d15e9274e1138af32fda1a13383', 'checksum': 'f124d4f070e89bdc3bb7293530584edcfaaf6863', 'changed': True, 'uid': 1000, 'gid': 1000, 'owner': 'apachy', 'group': 'apachy', 'mode': '0600', 'state': 'file', 'size': 1042, 'invocation': {'module_args': {'src': '/home/apachy/.ansible/tmp/ansible-tmp-1619598008.0377407-264508980829242/source', 'dest': '/home/apachy/.cache/molecule/webserver/default/Dockerfile_centos_latest', 'mode': '0600', 'follow': False, '_original_basename': 'Dockerfile.j2', 'checksum': 'f124d4f070e89bdc3bb7293530584edcfaaf6863', 'backup': False, 'force': True, 'content': None, 'validate': None, 'directory_mode': None, 'remote_src': None, 'local_follow': None, 'owner': None, 'group': None, 'seuser': None, 'serole': None, 'selevel': None, 'setype': None, 'attributes': None, 'regexp': None, 'delimiter': None, 'unsafe_writes': None}}, 'failed': False, 'item': {'image': 'centos:latest', 'name': 'instance_centos'}, 'ansible_loop_var': 'item', 'i': 0, 'ansible_index_var': 'i'})
ok: [localhost] => (item={'diff': [], 'dest': '/home/apachy/.cache/molecule/webserver/default/Dockerfile_debian_latest', 'src': '/home/apachy/.ansible/tmp/ansible-tmp-1619598009.0575206-7495714022136/source', 'md5sum': '649ddebedb96fceb09c1164c59bba0a1', 'checksum': '4c3834ad7b5c2728f426ba189b14721ca5b7bce8', 'changed': True, 'uid': 1000, 'gid': 1000, 'owner': 'apachy', 'group': 'apachy', 'mode': '0600', 'state': 'file', 'size': 1042, 'invocation': {'module_args': {'src': '/home/apachy/.ansible/tmp/ansible-tmp-1619598009.0575206-7495714022136/source', 'dest': '/home/apachy/.cache/molecule/webserver/default/Dockerfile_debian_latest', 'mode': '0600', 'follow': False, '_original_basename': 'Dockerfile.j2', 'checksum': '4c3834ad7b5c2728f426ba189b14721ca5b7bce8', 'backup': False, 'force': True, 'content': None, 'validate': None, 'directory_mode': None, 'remote_src': None, 'local_follow': None, 'owner': None, 'group': None, 'seuser': None, 'serole': None, 'selevel': None, 'setype': None, 'attributes': None, 'regexp': None, 'delimiter': None, 'unsafe_writes': None}}, 'failed': False, 'item': {'image': 'debian:latest', 'name': 'instance_debian'}, 'ansible_loop_var': 'item', 'i': 1, 'ansible_index_var': 'i'})
ok: [localhost] => (item={'diff': [], 'dest': '/home/apachy/.cache/molecule/webserver/default/Dockerfile_alpine_latest', 'src': '/home/apachy/.ansible/tmp/ansible-tmp-1619598009.8314095-69883168124416/source', 'md5sum': '7afa46f0c37e979894df3e5672da18f3', 'checksum': 'dc8c728b9401723fa718cf4a0e69a19a7890df35', 'changed': True, 'uid': 1000, 'gid': 1000, 'owner': 'apachy', 'group': 'apachy', 'mode': '0600', 'state': 'file', 'size': 1042, 'invocation': {'module_args': {'src': '/home/apachy/.ansible/tmp/ansible-tmp-1619598009.8314095-69883168124416/source', 'dest': '/home/apachy/.cache/molecule/webserver/default/Dockerfile_alpine_latest', 'mode': '0600', 'follow': False, '_original_basename': 'Dockerfile.j2', 'checksum': 'dc8c728b9401723fa718cf4a0e69a19a7890df35', 'backup': False, 'force': True, 'content': None, 'validate': None, 'directory_mode': None, 'remote_src': None, 'local_follow': None, 'owner': None, 'group': None, 'seuser': None, 'serole': None, 'selevel': None, 'setype': None, 'attributes': None, 'regexp': None, 'delimiter': None, 'unsafe_writes': None}}, 'failed': False, 'item': {'image': 'alpine:latest', 'name': 'instance_alpine'}, 'ansible_loop_var': 'item', 'i': 2, 'ansible_index_var': 'i'})

TASK [Build an Ansible compatible image (new)] *************************************************************
ok: [localhost] => (item=molecule_local/centos:latest)
ok: [localhost] => (item=molecule_local/debian:latest)
ok: [localhost] => (item=molecule_local/alpine:latest)

TASK [Create docker network(s)] ****************************************************************************

TASK [Determine the CMD directives] ************************************************************************
ok: [localhost] => (item={'image': 'centos:latest', 'name': 'instance_centos'})
ok: [localhost] => (item={'image': 'debian:latest', 'name': 'instance_debian'})
ok: [localhost] => (item={'image': 'alpine:latest', 'name': 'instance_alpine'})

TASK [Create molecule instance(s)] *************************************************************************
changed: [localhost] => (item=instance_centos)
changed: [localhost] => (item=instance_debian)
changed: [localhost] => (item=instance_alpine)

TASK [Wait for instance(s) creation to complete] ***********************************************************
changed: [localhost] => (item={'started': 1, 'finished': 0, 'ansible_job_id': '635047266173.77593', 'results_file': '/home/apachy/.ansible_async/635047266173.77593', 'changed': True, 'failed': False, 'item': {'image': 'centos:latest', 'name': 'instance_centos'}, 'ansible_loop_var': 'item'})
changed: [localhost] => (item={'started': 1, 'finished': 0, 'ansible_job_id': '637605267056.77619', 'results_file': '/home/apachy/.ansible_async/637605267056.77619', 'changed': True, 'failed': False, 'item': {'image': 'debian:latest', 'name': 'instance_debian'}, 'ansible_loop_var': 'item'})
changed: [localhost] => (item={'started': 1, 'finished': 0, 'ansible_job_id': '217242069572.77656', 'results_file': '/home/apachy/.ansible_async/217242069572.77656', 'changed': True, 'failed': False, 'item': {'image': 'alpine:latest', 'name': 'instance_alpine'}, 'ansible_loop_var': 'item'})

PLAY RECAP *************************************************************************************************
localhost                  : ok=7    changed=3    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0

INFO     Running default > prepare
WARNING  Skipping, prepare playbook not configured.
INFO     Running default > converge

PLAY [Converge] ********************************************************************************************

TASK [Gathering Facts] *************************************************************************************
ok: [instance_alpine]
ok: [instance_debian]
ok: [instance_centos]

TASK [Include webserver] ***********************************************************************************

TASK [webserver : Add epel-release repo] *******************************************************************
skipping: [instance_alpine]
skipping: [instance_debian]
changed: [instance_centos]

TASK [webserver : Nginx-RedHat. Install packages] **********************************************************
skipping: [instance_alpine]
skipping: [instance_debian]
changed: [instance_centos]

TASK [webserver : CentOS. Enable firewall port] ************************************************************
skipping: [instance_alpine]
skipping: [instance_debian]
fatal: [instance_centos]: FAILED! => {"changed": false, "msg": "Python Module not found: firewalld and its python module are required for this module,                         version 0.2.11 or newer required (0.3.9 or newer for offline operations)"}

TASK [webserver : reload service firewalld] ****************************************************************
skipping: [instance_alpine]
skipping: [instance_debian]

TASK [webserver : Create sites-available for CentOS] *******************************************************
skipping: [instance_alpine]
skipping: [instance_debian]

TASK [webserver : Create sites-enabled for CentOS] *********************************************************
skipping: [instance_alpine]
skipping: [instance_debian]

TASK [webserver : Add Centos site config] ******************************************************************
skipping: [instance_alpine] => (item={'site': 'local-site1.site', 'root': '/var/www/local-site1.site/html'})
skipping: [instance_alpine] => (item={'site': 'local-site2.site', 'root': '/var/www/local-site2.site/html'})
skipping: [instance_debian] => (item={'site': 'local-site1.site', 'root': '/var/www/local-site1.site/html'})
skipping: [instance_debian] => (item={'site': 'local-site2.site', 'root': '/var/www/local-site2.site/html'})

TASK [webserver : Remove Centos nginx config] **************************************************************
skipping: [instance_alpine]
skipping: [instance_debian]

TASK [webserver : Add Centos nginx config] *****************************************************************
skipping: [instance_alpine]
skipping: [instance_debian]

TASK [webserver : Create symlink nginx vhost Debian] *******************************************************
skipping: [instance_alpine] => (item={'site': 'local-site1.site', 'root': '/var/www/local-site1.site/html'})
skipping: [instance_alpine] => (item={'site': 'local-site2.site', 'root': '/var/www/local-site2.site/html'})
skipping: [instance_debian] => (item={'site': 'local-site1.site', 'root': '/var/www/local-site1.site/html'})
skipping: [instance_debian] => (item={'site': 'local-site2.site', 'root': '/var/www/local-site2.site/html'})

TASK [webserver : Nginx-Debian. Install packages] **********************************************************
skipping: [instance_alpine]
changed: [instance_debian]

TASK [webserver : Add Debian site config] ******************************************************************
skipping: [instance_alpine] => (item={'site': 'local-site1.site', 'root': '/var/www/local-site1.site/html'})
skipping: [instance_alpine] => (item={'site': 'local-site2.site', 'root': '/var/www/local-site2.site/html'})
changed: [instance_debian] => (item={'site': 'local-site1.site', 'root': '/var/www/local-site1.site/html'})
changed: [instance_debian] => (item={'site': 'local-site2.site', 'root': '/var/www/local-site2.site/html'})

TASK [webserver : Create symlink nginx vhost Debian] *******************************************************
skipping: [instance_alpine] => (item={'site': 'local-site1.site', 'root': '/var/www/local-site1.site/html'})
skipping: [instance_alpine] => (item={'site': 'local-site2.site', 'root': '/var/www/local-site2.site/html'})
changed: [instance_debian] => (item={'site': 'local-site1.site', 'root': '/var/www/local-site1.site/html'})
changed: [instance_debian] => (item={'site': 'local-site2.site', 'root': '/var/www/local-site2.site/html'})

TASK [webserver : Nginx. Enable and start servce] **********************************************************
changed: [instance_debian]
fatal: [instance_alpine]: FAILED! => {"changed": false, "msg": "Could not find the requested service nginx: "}

TASK [webserver : Check connection to Localhost] ***********************************************************
ok: [instance_debian]

TASK [webserver : print out] *******************************************************************************
ok: [instance_debian] => {
    "msg": {
        "changed": false,
        "elapsed": 0,
        "failed": false,
        "match_groupdict": {},
        "match_groups": [],
        "path": null,
        "port": 80,
        "search_regex": null,
        "state": "started"
    }
}

TASK [webserver : Templates] *******************************************************************************
fatal: [instance_debian]: FAILED! => {"changed": false, "msg": "AnsibleUndefinedVariable: \"hostvars['centos']\" is undefined"}

RUNNING HANDLER [webserver : restart nginx] ****************************************************************

PLAY RECAP *************************************************************************************************
instance_alpine            : ok=1    changed=0    unreachable=0    failed=1    skipped=13   rescued=0    ignored=0
instance_centos            : ok=3    changed=2    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0
instance_debian            : ok=7    changed=4    unreachable=0    failed=1    skipped=10   rescued=0    ignored=0


CRITICAL Ansible return code was 2, command was: ansible-playbook --inventory /home/apachy/.cache/molecule/webserver/default/inventory --skip-tags molecule-notest,notest /home/apachy/ansible13/roles/webserver/molecule/default/converge.yml
WARNING  An error occurred during the test sequence action: 'converge'. Cleaning up.
INFO     Running default > cleanup
WARNING  Skipping, cleanup playbook not configured.
INFO     Running default > destroy

PLAY [Destroy] *********************************************************************************************

TASK [Destroy molecule instance(s)] ************************************************************************
changed: [localhost] => (item=instance_centos)
changed: [localhost] => (item=instance_debian)
changed: [localhost] => (item=instance_alpine)

TASK [Wait for instance(s) deletion to complete] ***********************************************************
changed: [localhost] => (item={'started': 1, 'finished': 0, 'ansible_job_id': '629153785406.82072', 'results_file': '/home/apachy/.ansible_async/629153785406.82072', 'changed': True, 'failed': False, 'item': {'image': 'centos:latest', 'name': 'instance_centos'}, 'ansible_loop_var': 'item'})
changed: [localhost] => (item={'started': 1, 'finished': 0, 'ansible_job_id': '695839602691.82098', 'results_file': '/home/apachy/.ansible_async/695839602691.82098', 'changed': True, 'failed': False, 'item': {'image': 'debian:latest', 'name': 'instance_debian'}, 'ansible_loop_var': 'item'})
changed: [localhost] => (item={'started': 1, 'finished': 0, 'ansible_job_id': '814915688690.82123', 'results_file': '/home/apachy/.ansible_async/814915688690.82123', 'changed': True, 'failed': False, 'item': {'image': 'alpine:latest', 'name': 'instance_alpine'}, 'ansible_loop_var': 'item'})

TASK [Delete docker network(s)] ****************************************************************************

PLAY RECAP *************************************************************************************************
localhost                  : ok=2    changed=2    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0

INFO     Pruning extra files from scenario ephemeral directory

```

### Molecule test of check on CentOS, Debian, Alpine docker containers

```

apachy@apachy-server:~/ansible13/roles/check$ molecule test
INFO     default scenario test matrix: dependency, lint, cleanup, destroy, syntax, create, prepare, converge, idempotence, side_effect, verify, cleanup, destroy
INFO     Performing prerun...
INFO     Added ANSIBLE_ROLES_PATH=~/.ansible/roles:/usr/share/ansible/roles:/etc/ansible/roles:../../../.cache/roles
INFO     Running default > dependency
WARNING  Skipping, missing the requirements file.
WARNING  Skipping, missing the requirements file.
INFO     Running default > lint
INFO     Lint is disabled.
INFO     Running default > cleanup
WARNING  Skipping, cleanup playbook not configured.
INFO     Running default > destroy
INFO     Sanity checks: 'docker'

PLAY [Destroy] *********************************************************************************************

TASK [Destroy molecule instance(s)] ************************************************************************
changed: [localhost] => (item=instance_centos)
changed: [localhost] => (item=instance_debian)
changed: [localhost] => (item=instance_alpine)

TASK [Wait for instance(s) deletion to complete] ***********************************************************
ok: [localhost] => (item={'started': 1, 'finished': 0, 'ansible_job_id': '892566689472.66216', 'results_file': '/home/apachy/.ansible_async/892566689472.66216', 'changed': True, 'failed': False, 'item': {'image': 'centos:latest', 'name': 'instance_centos'}, 'ansible_loop_var': 'item'})
ok: [localhost] => (item={'started': 1, 'finished': 0, 'ansible_job_id': '408494783290.66242', 'results_file': '/home/apachy/.ansible_async/408494783290.66242', 'changed': True, 'failed': False, 'item': {'image': 'debian:latest', 'name': 'instance_debian'}, 'ansible_loop_var': 'item'})
ok: [localhost] => (item={'started': 1, 'finished': 0, 'ansible_job_id': '829262591675.66267', 'results_file': '/home/apachy/.ansible_async/829262591675.66267', 'changed': True, 'failed': False, 'item': {'image': 'alpine:latest', 'name': 'instance_alpine'}, 'ansible_loop_var': 'item'})

TASK [Delete docker network(s)] ****************************************************************************

PLAY RECAP *************************************************************************************************
localhost                  : ok=2    changed=1    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0

INFO     Running default > syntax

playbook: /home/apachy/ansible13/roles/check/molecule/default/converge.yml
INFO     Running default > create

PLAY [Create] **********************************************************************************************

TASK [Log into a Docker registry] **************************************************************************
skipping: [localhost] => (item={'image': 'centos:latest', 'name': 'instance_centos'})
skipping: [localhost] => (item={'image': 'debian:latest', 'name': 'instance_debian'})
skipping: [localhost] => (item={'image': 'alpine:latest', 'name': 'instance_alpine'})

TASK [Check presence of custom Dockerfiles] ****************************************************************
ok: [localhost] => (item={'image': 'centos:latest', 'name': 'instance_centos'})
ok: [localhost] => (item={'image': 'debian:latest', 'name': 'instance_debian'})
ok: [localhost] => (item={'image': 'alpine:latest', 'name': 'instance_alpine'})

TASK [Create Dockerfiles from image names] *****************************************************************
changed: [localhost] => (item={'image': 'centos:latest', 'name': 'instance_centos'})
changed: [localhost] => (item={'image': 'debian:latest', 'name': 'instance_debian'})
changed: [localhost] => (item={'image': 'alpine:latest', 'name': 'instance_alpine'})

TASK [Discover local Docker images] ************************************************************************
ok: [localhost] => (item={'diff': [], 'dest': '/home/apachy/.cache/molecule/check/default/Dockerfile_centos_latest', 'src': '/home/apachy/.ansible/tmp/ansible-tmp-1619596372.3019621-148387263372730/source', 'md5sum': '486f0d15e9274e1138af32fda1a13383', 'checksum': 'f124d4f070e89bdc3bb7293530584edcfaaf6863', 'changed': True, 'uid': 1000, 'gid': 1000, 'owner': 'apachy', 'group': 'apachy', 'mode': '0600', 'state': 'file', 'size': 1042, 'invocation': {'module_args': {'src': '/home/apachy/.ansible/tmp/ansible-tmp-1619596372.3019621-148387263372730/source', 'dest': '/home/apachy/.cache/molecule/check/default/Dockerfile_centos_latest', 'mode': '0600', 'follow': False, '_original_basename': 'Dockerfile.j2', 'checksum': 'f124d4f070e89bdc3bb7293530584edcfaaf6863', 'backup': False, 'force': True, 'content': None, 'validate': None, 'directory_mode': None, 'remote_src': None, 'local_follow': None, 'owner': None, 'group': None, 'seuser': None, 'serole': None, 'selevel': None, 'setype': None, 'attributes': None, 'regexp': None, 'delimiter': None, 'unsafe_writes': None}}, 'failed': False, 'item': {'image': 'centos:latest', 'name': 'instance_centos'}, 'ansible_loop_var': 'item', 'i': 0, 'ansible_index_var': 'i'})
ok: [localhost] => (item={'diff': [], 'dest': '/home/apachy/.cache/molecule/check/default/Dockerfile_debian_latest', 'src': '/home/apachy/.ansible/tmp/ansible-tmp-1619596373.367616-20287948186417/source', 'md5sum': '649ddebedb96fceb09c1164c59bba0a1', 'checksum': '4c3834ad7b5c2728f426ba189b14721ca5b7bce8', 'changed': True, 'uid': 1000, 'gid': 1000, 'owner': 'apachy', 'group': 'apachy', 'mode': '0600', 'state': 'file', 'size': 1042, 'invocation': {'module_args': {'src': '/home/apachy/.ansible/tmp/ansible-tmp-1619596373.367616-20287948186417/source', 'dest': '/home/apachy/.cache/molecule/check/default/Dockerfile_debian_latest', 'mode': '0600', 'follow': False, '_original_basename': 'Dockerfile.j2', 'checksum': '4c3834ad7b5c2728f426ba189b14721ca5b7bce8', 'backup': False, 'force': True, 'content': None, 'validate': None, 'directory_mode': None, 'remote_src': None, 'local_follow': None, 'owner': None, 'group': None, 'seuser': None, 'serole': None, 'selevel': None, 'setype': None, 'attributes': None, 'regexp': None, 'delimiter': None, 'unsafe_writes': None}}, 'failed': False, 'item': {'image': 'debian:latest', 'name': 'instance_debian'}, 'ansible_loop_var': 'item', 'i': 1, 'ansible_index_var': 'i'})
ok: [localhost] => (item={'diff': [], 'dest': '/home/apachy/.cache/molecule/check/default/Dockerfile_alpine_latest', 'src': '/home/apachy/.ansible/tmp/ansible-tmp-1619596374.1768003-234001166977283/source', 'md5sum': '7afa46f0c37e979894df3e5672da18f3', 'checksum': 'dc8c728b9401723fa718cf4a0e69a19a7890df35', 'changed': True, 'uid': 1000, 'gid': 1000, 'owner': 'apachy', 'group': 'apachy', 'mode': '0600', 'state': 'file', 'size': 1042, 'invocation': {'module_args': {'src': '/home/apachy/.ansible/tmp/ansible-tmp-1619596374.1768003-234001166977283/source', 'dest': '/home/apachy/.cache/molecule/check/default/Dockerfile_alpine_latest', 'mode': '0600', 'follow': False, '_original_basename': 'Dockerfile.j2', 'checksum': 'dc8c728b9401723fa718cf4a0e69a19a7890df35', 'backup': False, 'force': True, 'content': None, 'validate': None, 'directory_mode': None, 'remote_src': None, 'local_follow': None, 'owner': None, 'group': None, 'seuser': None, 'serole': None, 'selevel': None, 'setype': None, 'attributes': None, 'regexp': None, 'delimiter': None, 'unsafe_writes': None}}, 'failed': False, 'item': {'image': 'alpine:latest', 'name': 'instance_alpine'}, 'ansible_loop_var': 'item', 'i': 2, 'ansible_index_var': 'i'})

TASK [Build an Ansible compatible image (new)] *************************************************************
ok: [localhost] => (item=molecule_local/centos:latest)
ok: [localhost] => (item=molecule_local/debian:latest)
ok: [localhost] => (item=molecule_local/alpine:latest)

TASK [Create docker network(s)] ****************************************************************************

TASK [Determine the CMD directives] ************************************************************************
ok: [localhost] => (item={'image': 'centos:latest', 'name': 'instance_centos'})
ok: [localhost] => (item={'image': 'debian:latest', 'name': 'instance_debian'})
ok: [localhost] => (item={'image': 'alpine:latest', 'name': 'instance_alpine'})

TASK [Create molecule instance(s)] *************************************************************************
changed: [localhost] => (item=instance_centos)
changed: [localhost] => (item=instance_debian)
changed: [localhost] => (item=instance_alpine)

TASK [Wait for instance(s) creation to complete] ***********************************************************
changed: [localhost] => (item={'started': 1, 'finished': 0, 'ansible_job_id': '843355439840.66832', 'results_file': '/home/apachy/.ansible_async/843355439840.66832', 'changed': True, 'failed': False, 'item': {'image': 'centos:latest', 'name': 'instance_centos'}, 'ansible_loop_var': 'item'})
changed: [localhost] => (item={'started': 1, 'finished': 0, 'ansible_job_id': '475845497171.66858', 'results_file': '/home/apachy/.ansible_async/475845497171.66858', 'changed': True, 'failed': False, 'item': {'image': 'debian:latest', 'name': 'instance_debian'}, 'ansible_loop_var': 'item'})
changed: [localhost] => (item={'started': 1, 'finished': 0, 'ansible_job_id': '221417750617.66895', 'results_file': '/home/apachy/.ansible_async/221417750617.66895', 'changed': True, 'failed': False, 'item': {'image': 'alpine:latest', 'name': 'instance_alpine'}, 'ansible_loop_var': 'item'})

PLAY RECAP *************************************************************************************************
localhost                  : ok=7    changed=3    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0

INFO     Running default > prepare
WARNING  Skipping, prepare playbook not configured.
INFO     Running default > converge

PLAY [Converge] ********************************************************************************************

TASK [Gathering Facts] *************************************************************************************
ok: [instance_debian]
ok: [instance_alpine]
ok: [instance_centos]

TASK [Include check] ***************************************************************************************

TASK [check : Check SUDO with NOPASSWD] ********************************************************************
ok: [instance_alpine]
ok: [instance_debian]
ok: [instance_centos]

TASK [check : Check public repositories] *******************************************************************
ok: [instance_centos] => (item={'url': 'ftp.by.debian.org', 'port': 80})
ok: [instance_debian] => (item={'url': 'ftp.by.debian.org', 'port': 80})
ok: [instance_alpine] => (item={'url': 'ftp.by.debian.org', 'port': 80})
ok: [instance_centos] => (item={'url': 'ftp.byfly.by', 'port': 80})
ok: [instance_debian] => (item={'url': 'ftp.byfly.by', 'port': 80})
ok: [instance_alpine] => (item={'url': 'ftp.byfly.by', 'port': 80})
ok: [instance_centos] => (item={'url': 'pypi.org', 'port': 443})
ok: [instance_debian] => (item={'url': 'pypi.org', 'port': 443})
ok: [instance_alpine] => (item={'url': 'pypi.org', 'port': 443})

TASK [check : Check connection to doker] *******************************************************************
ok: [instance_debian] => (item=https://registry.hub.docker.com)
ok: [instance_alpine] => (item=https://registry.hub.docker.com)
ok: [instance_centos] => (item=https://registry.hub.docker.com)

TASK [check : Print output] ********************************************************************************
ok: [instance_alpine] => (item=200) => {
    "msg": "200"
}
ok: [instance_centos] => (item=200) => {
    "msg": "200"
}
ok: [instance_debian] => (item=200) => {
    "msg": "200"
}

TASK [check : Check RAM] ***********************************************************************************
failed: [instance_alpine] (item={'real': {'total': 981, 'used': 860, 'free': 121}, 'nocache': {'free': 483, 'used': 498}, 'swap': {'total': 1961, 'free': 1930, 'used': 31, 'cached': 1}}) => {
    "ansible_loop_var": "item",
    "assertion": "ansible_memtotal_mb >= 2024",
    "changed": false,
    "evaluated_to": false,
    "item": {
        "nocache": {
            "free": 483,
            "used": 498
        },
        "real": {
            "free": 121,
            "total": 981,
            "used": 860
        },
        "swap": {
            "cached": 1,
            "free": 1930,
            "total": 1961,
            "used": 31
        }
    },
    "msg": "Host has enough RAM"
}
failed: [instance_centos] (item={'real': {'total': 981, 'used': 881, 'free': 100}, 'nocache': {'free': 459, 'used': 522}, 'swap': {'total': 1961, 'free': 1930, 'used': 31, 'cached': 1}}) => {
    "ansible_loop_var": "item",
    "assertion": "ansible_memtotal_mb >= 2024",
    "changed": false,
    "evaluated_to": false,
    "item": {
        "nocache": {
            "free": 459,
            "used": 522
        },
        "real": {
            "free": 100,
            "total": 981,
            "used": 881
        },
        "swap": {
            "cached": 1,
            "free": 1930,
            "total": 1961,
            "used": 31
        }
    },
    "msg": "Host has enough RAM"
}
failed: [instance_debian] (item={'real': {'total': 981, 'used': 886, 'free': 95}, 'nocache': {'free': 452, 'used': 529}, 'swap': {'total': 1961, 'free': 1930, 'used': 31, 'cached': 1}}) => {
    "ansible_loop_var": "item",
    "assertion": "ansible_memtotal_mb >= 2024",
    "changed": false,
    "evaluated_to": false,
    "item": {
        "nocache": {
            "free": 452,
            "used": 529
        },
        "real": {
            "free": 95,
            "total": 981,
            "used": 886
        },
        "swap": {
            "cached": 1,
            "free": 1930,
            "total": 1961,
            "used": 31
        }
    },
    "msg": "Host has enough RAM"
}

PLAY RECAP *************************************************************************************************
instance_alpine            : ok=5    changed=0    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0
instance_centos            : ok=5    changed=0    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0
instance_debian            : ok=5    changed=0    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0

CRITICAL Ansible return code was 2, command was: ansible-playbook --inventory /home/apachy/.cache/molecule/check/default/inventory --skip-tags molecule-notest,notest /home/apachy/ansible13/roles/check/molecule/default/converge.yml
WARNING  An error occurred during the test sequence action: 'converge'. Cleaning up.
INFO     Running default > cleanup
WARNING  Skipping, cleanup playbook not configured.
INFO     Running default > destroy

PLAY [Destroy] *********************************************************************************************

TASK [Destroy molecule instance(s)] ************************************************************************
changed: [localhost] => (item=instance_centos)
changed: [localhost] => (item=instance_debian)
changed: [localhost] => (item=instance_alpine)

TASK [Wait for instance(s) deletion to complete] ***********************************************************
changed: [localhost] => (item={'started': 1, 'finished': 0, 'ansible_job_id': '526444947622.70649', 'results_file': '/home/apachy/.ansible_async/526444947622.70649', 'changed': True, 'failed': False, 'item': {'image': 'centos:latest', 'name': 'instance_centos'}, 'ansible_loop_var': 'item'})
changed: [localhost] => (item={'started': 1, 'finished': 0, 'ansible_job_id': '571868664281.70675', 'results_file': '/home/apachy/.ansible_async/571868664281.70675', 'changed': True, 'failed': False, 'item': {'image': 'debian:latest', 'name': 'instance_debian'}, 'ansible_loop_var': 'item'})
changed: [localhost] => (item={'started': 1, 'finished': 0, 'ansible_job_id': '640834056242.70718', 'results_file': '/home/apachy/.ansible_async/640834056242.70718', 'changed': True, 'failed': False, 'item': {'image': 'alpine:latest', 'name': 'instance_alpine'}, 'ansible_loop_var': 'item'})

TASK [Delete docker network(s)] ****************************************************************************

PLAY RECAP *************************************************************************************************
localhost                  : ok=2    changed=2    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0

INFO     Pruning extra files from scenario ephemeral directory

```
